{% extends "base.html" %}

{% block title %}{{ one_product.name }} - {{ brand.name }}{% endblock %}

{% block content %}
<div class="container mt-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-md-6 text-center position-relative">
            {% if one_product.image %}
            <div class="position-relative" style="display:inline-block;">
                <img id="mainImage" src="{{ one_product.image }}"
                     class="img-fluid rounded shadow-sm"
                     alt="{{ one_product.name }}"
                     style="max-height: 400px; object-fit: contain;">
                <div id="zoomLens"></div>
            </div>
            <div id="zoomResult" class="border"></div>
            {% else %}
            <div class="d-flex align-items-center justify-content-center bg-light rounded"
                 style="height: 400px;">
                <span class="text-muted">No Image</span>
            </div>
            {% endif %}
        </div>

        <div class="col-md-6">
            <h2 class="fw-bold mb-3">{{ one_product.name }}</h2>
            <p class="text-muted">{{ one_product.description }}</p>

            <ul class="list-unstyled mb-4">
                <li><strong>Brand:</strong> {{ brand.name }}</li>
                <li><strong>Type:</strong> {{ one_product.type }}</li>
                <li><strong>In Stock:</strong> {{ one_product.stock }}</li>
            </ul>

            <div class="mb-4">
                {% if one_product.discount_price %}
                <span class="text-muted text-decoration-line-through me-2">
                    ${{ "%.2f"|format(one_product.price) }}
                </span>
                <span class="text-primary fw-bold h4">
                    ${{ "%.2f"|format(one_product.discount_price) }}
                </span>
                {% else %}
                <span class="text-primary fw-bold h4">
                    ${{ "%.2f"|format(one_product.price) }}
                </span>
                {% endif %}
            </div>

            <form action="{{ url_for('basket.add_to_basket', product_id=one_product.id) }}" method="POST">
                <input type="hidden" name="brand_id" value="{{ brand.id }}">
                <button type="submit" class="btn btn-success btn-lg mt-3">
                    <i class="bi bi-cart-plus"></i> Add to Basket
                </button>
                {% if current_user.is_authenticated and current_user.is_admin %}
                <a href="{{ url_for('delete_product', product_id=one_product.id) }}" class="btn btn-outline-danger btn-sm">Delete</a>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<style>
    #zoomLens {
        position: absolute;
        border: 1px solid #000;
        width: 100px;
        height: 100px;
        opacity: 0.4;
        background-color: #fff;
        display: none;
        pointer-events: none;
    }

    #zoomResult {
        display: none;
        position: absolute;
        width: 500px;
        height: 500px;
        background-repeat: no-repeat;
        background-color: white;
        z-index: 10;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
</style>

<script>
    const img = document.getElementById("mainImage");
    const lens = document.getElementById("zoomLens");
    const result = document.getElementById("zoomResult");

    if (img && lens && result) {
        let imgRect = img.getBoundingClientRect();
        const zoomLevel = 1.0; // Reduced zoom level to minimal magnification

        // Set background image for zoom result
        result.style.backgroundImage = `url('${img.src}')`;

        // Update image rectangle on window resize
        window.addEventListener("resize", () => {
            imgRect = img.getBoundingClientRect();
        });

        img.addEventListener("mouseenter", () => {
            lens.style.display = "block";
            result.style.display = "block";
            imgRect = img.getBoundingClientRect(); // Refresh on enter
        });

        img.addEventListener("mouseleave", () => {
            lens.style.display = "none";
            result.style.display = "none";
        });

        img.addEventListener("mousemove", (e) => {
            // Prevent default to reduce lag
            e.preventDefault();

            // Get mouse position relative to image
            const x = e.clientX - imgRect.left;
            const y = e.clientY - imgRect.top;

            // Calculate lens position
            let lensX = x - lens.offsetWidth / 2;
            let lensY = y - lens.offsetHeight / 2;

            // Clamp lens inside image boundaries
            lensX = Math.max(0, Math.min(lensX, imgRect.width - lens.offsetWidth));
            lensY = Math.max(0, Math.min(lensY, imgRect.height - lens.offsetHeight));

            // Update lens position
            lens.style.left = lensX + "px";
            lens.style.top = lensY + "px";

            // Calculate zoom factors to match lens area to zoom result
            const cx = (result.offsetWidth / lens.offsetWidth) * zoomLevel;
            const cy = (result.offsetHeight / lens.offsetHeight) * zoomLevel;

            // Calculate zoom result background position to center the lens area
            const bgX = -(lensX * cx) + (result.offsetWidth / 2 - (lens.offsetWidth * cx) / 2);
            const bgY = -(lensY * cy) + (result.offsetHeight / 2 - (lens.offsetHeight * cy) / 2);

            // Set background size and position
            result.style.backgroundSize = `${imgRect.width * cx}px ${imgRect.height * cy}px`;
            result.style.backgroundPosition = `${bgX}px ${bgY}px`;

            // Dynamically position zoom result to stay within viewport
            const viewportWidth = window.innerWidth;
            const imgRight = imgRect.right;
            const zoomWidth = result.offsetWidth;

            // Place zoom result to the right if possible, else to the left
            if (imgRight + zoomWidth + 20 < viewportWidth) {
                result.style.left = `${imgRight + 10}px`;
                result.style.top = `${imgRect.top}px`;
            } else {
                result.style.left = `${imgRect.left - zoomWidth - 10}px`;
                result.style.top = `${imgRect.top}px`;
            }
        });
    }
</script>

{% endblock %}